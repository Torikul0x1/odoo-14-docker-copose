<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <!-- configure signature in purchase setting -->
        <record id="res_config_settings_view_purchase_form" model="ir.ui.view">
            <field name="name">digital.signature.purchase</field>
            <field name="model">res.config.settings</field>
            <field name="inherit_id" ref="purchase.res_config_settings_view_form_purchase"/>
            <field name="arch" type="xml">
                <xpath expr="//div[@data-key='purchase']" position="inside">
                    <h2>Digital Signature</h2>
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <div class="mt8">
                                    <field name="is_sign_purchase" class="o_light_label"/>
                                </div>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="is_sign_purchase" string="Allow Digital Signature for Purchase Order"/>
                                <div class="text-muted">
                                    Allow Digital Signature in Purchase Order.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt16 o_settings_container"
                         attrs="{'invisible': [('is_sign_purchase', '=', False)]}">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane">
                                <div class="mt8">
                                    <field name="is_confirm_sign_purchase" class="o_light_label"/>
                                </div>
                            </div>
                            <div class="o_setting_right_pane">
                                <label for="is_confirm_sign_purchase"/>
                                <div class="text-muted">
                                    Digital Signature must be add before confirm purchase order.
                                </div>
                            </div>
                        </div>
                    </div>

                </xpath>
            </field>
        </record>

        <!-- add signature in purchase -->
        <record id="purchase_inherit_digital_signature" model="ir.ui.view">
            <field name="name">purchase.form.digital.signature</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="/form/sheet" position="inside">
                    <group attrs="{'invisible': [('digital_sign_purchase_compute', '=', False)]}">
                        <field name="digital_sign_purchase_compute" invisible="1"/>
                        <label for="digital_signature" string="Signature" class="oe_edit_only"/>
                        <h2>
                            <field name="digital_signature" widget="signature"/>
                        </h2>
                    </group>
                </xpath>
                <xpath expr="//page[@name='products']" position="inside">
                    <div>
                        <label for="prepare_by"/>
                        <field name="prepare_by"/>
                    </div>
                    <div>
                        <label for="approve_by"/>
                        <field name="approve_by"/>
                    </div>
                </xpath>
            </field>
        </record>

        <template id="report_purchaseorder_document" inherit_id="purchase.report_purchaseorder_document">
            <xpath expr="//t[@t-call='web.external_layout']" position="replace">
                <t t-call="web.external_layout">
                    <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
                    <div class="page">
                        <div class="oe_structure"/>

                        <h2 class="text-center">
                            <!--                        <span t-if="o.state == 'draft'"><u>Request for Quotation</u></span>-->
                            <span t-if="o.state == 'draft'">
                                <u>Purchase Order</u>
                            </span>
                            <span t-if="o.state in ['sent', 'to approve']">
                                <u>Local Purchase Order</u>
                            </span>
                            <span t-if="o.state in ['purchase', 'done']">
                                <u>Local Purchase Order</u>
                            </span>
                            <span t-if="o.state == 'cancel'">
                                <u>Cancelled Purchase Order</u>
                            </span>
                        </h2>

                        <h5 class="text-center" style="margin-top:-6px;font-size:18px;">
                            <strong>LPO Number:</strong>
                            <span t-field="o.name"/>
                        </h5>

                        <div class="row oe_mt16">
                            <div class="col-6">
                                <strong>Supplier:</strong>
                                <div t-field="o.partner_id"
                                     t-options='{"widget": "contact", "fields": ["name", "address"], "no_marker": True}'/>
                            </div>
                            <div class="col-6 text-right">
                                <t t-if="o.dest_address_id">
                                    <!--                                <strong>Ship To: </strong>-->
                                    <strong>Delivery To:</strong>
                                    <div t-field="o.dest_address_id"
                                         t-options='{"widget": "contact", "fields": ["name", "address", "phone"], "no_marker": True, "phone_icons": True}'/>
                                </t>
                            </div>
                        </div>

                        <!--                    <div class="row oe_mt16">-->
                        <!--                        <div class="col-12">-->
                        <!--                            <strong>LPO No.: </strong><span t-field="o.name"/>-->
                        <!--                        </div>-->
                        <!--                    </div>-->

                        <div id="informations" class="row oe_mt16 oe_mb16">
                            <div t-if="o.user_id" class="col-auto col-3 bm-2">
                                <strong>Purchase Representative:</strong>
                                <p t-field="o.user_id" class="m-0"/>
                            </div>
                            <div t-if="o.partner_ref" class="col-auto col-3 bm-2">
                                <strong>Order Reference:</strong>
                                <p t-field="o.partner_ref" class="m-0"/>
                            </div>
                            <div t-if="o.date_order" class="col-auto col-3 bm-2">
                                <strong>Order Date:</strong>
                                <p t-field="o.date_order" t-options="{'widget': 'date'}" class="m-0"/>
                            </div>
                            <div t-if="o.date_planned" class="col-auto col-3 bm-2">
                                <strong>Delivery Date:</strong>
                                <p t-field="o.date_planned" t-options="{'widget': 'date'}" class="m-0"/>
                            </div>
                            <div t-if="o.payment_term_id" class="col-auto col-3 bm-2">
                                <strong>Payment Terms:</strong>
                                <p t-field="o.payment_term_id" class="m-0"/>
                            </div>
                        </div>

                        <table class="table table-sm o_main_table">
                            <thead>
                                <tr>
                                    <th name="th_sr_no">
                                        <strong>Sl No.</strong>
                                    </th>
                                    <!--                                <th name="th_item_code"><strong>Item Code</strong></th>-->
                                    <th name="th_description">
                                        <strong>Description</strong>
                                    </th>
                                    <th name="th_unit" class="text-right">
                                        <strong>Units</strong>
                                    </th>
                                    <th name="th_quantity" class="text-right">
                                        <strong>Qty</strong>
                                    </th>
                                    <th name="th_price_unit" class="text-right">
                                        <strong>Unit Price</strong>
                                    </th>
                                    <th name="th_taxes">
                                        <strong>VAT</strong>
                                    </th>
                                    <th name="th_amount" class="text-right">
                                        <strong>Amount</strong>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="current_subtotal" t-value="0"/>
                                <t t-set="sr_no" t-value="1"/>
                                <t t-foreach="o.order_line" t-as="line">
                                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"
                                       groups="account.group_show_line_subtotals_tax_excluded"/>
                                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_total"
                                       groups="account.group_show_line_subtotals_tax_included"/>

                                    <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                                        <t t-if="not line.display_type">
                                            <td class="text-center">
                                                <span t-esc="sr_no"/>
                                                <t t-set="sr_no" t-value="sr_no+1"/>
                                            </td>
                                            <!--                                        <td name="td_item_code">-->
                                            <!--                                            <span t-field="line.product_id.item_code"/>-->
                                            <!--                                        </td>-->
                                            <td id="product">
                                                <span t-field="line.name"/>
                                            </td>
                                            <td name="td_unit">
                                                <span t-field="line.product_uom.name" groups="uom.group_uom"/>
                                            </td>
                                            <td class="text-right">
                                                <span t-field="line.product_qty"/>
                                            </td>
                                            <td class="text-right">
                                                <span t-field="line.price_unit"/>
                                            </td>
                                            <td name="td_taxes">
                                                <span t-esc="', '.join(map(lambda x: x.name, line.taxes_id))"/>
                                            </td>
                                            <td class="text-right">
                                                <span t-field="line.price_subtotal"
                                                      t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                            </td>
                                        </t>
                                        <t t-if="line.display_type == 'line_section'">
                                            <td colspan="99" id="section">
                                                <span t-field="line.name"/>
                                            </td>
                                            <t t-set="current_section" t-value="line"/>
                                            <t t-set="current_subtotal" t-value="0"/>
                                        </t>
                                        <t t-if="line.display_type == 'line_note'">
                                            <td colspan="99" id="note">
                                                <span t-field="line.name"/>
                                            </td>
                                        </t>
                                    </tr>
                                    <t t-if="current_section and (line_last or o.order_line[line_index+1].display_type == 'line_section')">
                                        <tr class="is-subtotal text-right">
                                            <td colspan="99" id="subtotal">
                                                <strong class="mr16">Subtotal</strong>
                                                <span
                                                        t-esc="current_subtotal"
                                                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                                                />
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                            </tbody>
                        </table>

                        <div id="total" class="row justify-content-end">
                            <div class="col-8">
                                <div class="oe_mt16 oe_mb16">
                                    <strong>Amount In Words:</strong>
                                    <span t-field="o.num_word"/>
                                    <span>Only.</span>
                                </div>
                            </div>
                            <div class="col-4">
                                <table class="table table-sm">
                                    <tr class="border-black">
                                        <td name="td_subtotal_label">
                                            <strong>Subtotal</strong>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="o.amount_untaxed"
                                                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td name="td_taxes_label">VAT</td>
                                        <td class="text-right">
                                            <span t-field="o.amount_tax"
                                                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                    <tr class="border-black o_total">
                                        <td name="td_amount_total_label">
                                            <strong>Total</strong>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="o.amount_total"
                                                  t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="row oe_mt16">
                            <div class="col-12">
                                <t t-if="o.notes">
                                    <strong>Terms and Conditions:</strong>
                                    <p t-field="o.notes"/>
                                </t>
                            </div>
                        </div>

                        <!--<div class="row" style="margin-top: 128px;">
                            <div class="col-4 text-left">
                                <strong><u>Prepared by: </u></strong>
                            </div>
                            <div class="col-4 text-center">
                                <strong><u>Checked by: </u></strong>
                            </div>
                            <div class="col-4 text-right">
                                <strong><u>Approved by: </u></strong>
                            </div>
                        </div>-->

                        <t t-set="signature" t-value="o.get_signature()"/>
                        <div t-if="signature" class="d-flex justify-content-center col-12 ">
                            <t t-if="o.prepare_by and o.prepare_by.user_stamp">
                                <img t-att-src="image_data_uri(o.prepare_by.user_stamp)"
                                     class="rounded mx-auto d-block" alt="Stamp"/>
                            </t>
                        </div>

                        <div t-if="signature" class="row oe_mt64">
                            <div style="margin-bottom:0px" class="col-4 text-left">
                                <t t-if="o.prepare_by and o.prepare_by.user_signature">
                                    <img t-att-src="image_data_uri(o.prepare_by.user_signature)" style="height:50px;"
                                         class="float-left w-100" alt="Prepare By."/>
                                </t>
                                <strong>
                                    <div style="text-decoration:overline margin-bottom:0px;">
                                        <span t-field="signature.signature1"/>
                                        <span t-if="o.prepare_by" t-field="o.prepare_by"/>
                                    </div>
                                </strong>
                            </div>
                            <div style="margin-bottom:0px" class="col-4 text-center">
                                <strong>
                                    <span style="text-decoration:overline" t-field="signature.signature2"/>
                                </strong>
                            </div>
                            <div  class="col-4 text-right">
                                <t t-if="o.approve_by and o.approve_by.user_signature">
                                    <img t-att-src="image_data_uri(o.approve_by.user_signature)"
                                         class="float-left w-100" style="height:50px;" alt="Approve by."/>
                                </t>
                                <strong>
                                    <div style="text-decoration:overline; margin-bottom:0px;">
                                        <strin t-field="signature.signature3"/>
                                        <span t-if="o.approve_by" t-field="o.approve_by"/>
                                    </div>
                                </strong>
                            </div>
                        </div>
                        <div class="oe_structure"/>
                    </div>
                </t>
            </xpath>
        </template>

        <!--Inherit Purchase Report for Metrix-->
        <!--        <template id="grid_purchaseorder_inherit_custom"-->
        <!--                  inherit_id="purchase_product_matrix.grid_purchaseorder_inherit">-->
        <!--            <xpath expr="//t[@t-call='product_matrix.matrix']" position="replace"/>-->
        <!--        </template>-->

        <!--        &lt;!&ndash;Inherit Quotation Report for Metrix&ndash;&gt;-->
        <!--        <template id="grid_report_purchaseorder_template_inherit_custom"-->
        <!--                  inherit_id="purchase_product_matrix.grid_report_purchaseorder_template_inherit">-->
        <!--            <xpath expr="//t[@t-call='product_matrix.matrix']" position="replace"/>-->
        <!--        </template>-->

    </data>
</odoo>
